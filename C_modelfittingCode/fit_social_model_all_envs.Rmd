---
title: "Modelfitting"
author: "Simon&Andrea"
date: '2022-10-120'
output: html_document
---

```{r setup, include=FALSE}
pacman::p_load(tidyverse, rjson, DEoptim, doParallel, here)
knitr::opts_knit$set(root.dir = here()) # set root fot the whole file
```

In this document, we will fit a kalman filter to the "social bandit" task that Andrea and I developed. 
First, lets load some data.

```{r}
source("./C_modelfittingCode/models.R") # modelcode for fitting
source("./B_SimulationCode/load_environments.R") # environments
source("./B_SimulationCode/sim_models.R") # modelcode for simulation

# load behavioral data
#explore_data <- read_csv(file = paste0("./Data/data_coord.csv"))
social_data<-read_csv(file = paste0("./data/social/data_social_coord.csv"))
```

# Fit model to social data
This function fits the model specified in models mle and stores the parameter estimates as well as the fit index (lower is better)
alongside the pariticipant data in long format

```{r}
cl <- parallel::makeCluster(15)
doParallel::registerDoParallel(cl)

source("./C_modelfittingCode/models_mle.R")
 social_fits<-foreach(
   player_nr = unique(social_data$player),
   .packages = c("DEoptim", "dplyr"),
   .combine="rbind"
 ) %dopar% {
  
 # for(player_nr in unique(social_data$player)){
  # browser()
  Xnew <- as.matrix(expand.grid(0:7, 0:7)) # do this outside the loop for better speed
  output <- c()
  
  # social data TODO: concatenate nonsocial data.
  d1 <- subset(social_data, player == player_nr) %>%
    group_by(round) %>%
    mutate(z = (points - 0) /100,
           social_info=social_info+1,
           choices=cells) %>%rowwise()%>%
    mutate(social_info=ifelse(social_info==65,64,social_info))%>%
    ungroup()
#  d1$z=d1$points
  # print(d1_round)
  
  rounds <- unique(d1$round)
  print(player_nr)
  #for (r in rounds) { # loop through rounds in roundList
  cv <- fit_fun(d1 = d1) # only try one sub
  d1$fit<-unlist(cv[1])
  d1$lr<-unlist(cv[2])
  d1$tau<-unlist(cv[3])
  d1$soc_w<-unlist(cv[4])
  
 #saveRDS(output, file = paste0("A_GeneratedFiles/modelfits/social_models/Q_fit", player_nr, ".rds"))
  return(d1)
}
```





# simulate
Here i take the dataframe from the previous modelfitting and simulate new data.
```{r}
#environment files are in generated files
environments<-load_envs(path="./A_GeneratedFiles/")


social_sims_plot_d<-foreach(
  player_nr = unique(social_fits$player),
  .packages = c("DEoptim", "dplyr"),
  .combine="rbind"
) %dopar% {
  # browser()
  Xnew <- as.matrix(expand.grid(0:7, 0:7)) # do this outside the loop for better speed
  output <- c()
  
  # social data TODO: concatenate nonsocial data.
  d1 <- subset(social_fits, player == player_nr) %>%
    group_by(round) %>%
    mutate(z = (points - mean(points)) / sd(points),
           social_info=social_info+1,
           choices=cells) %>%rowwise()%>%
    mutate(social_info=ifelse(social_info==65,64,social_info))%>%
    ungroup()
  
  #### unpack parameters
  estimates<-c(
    unique(d1$lr),
    unique(d1$tau),
    unique(d1$soc_w)
  )
  ####
  #for (r in rounds) { # loop through rounds in roundList
  cv <- explore_env_social_fitted_pars(
    par = estimates, 
    learning_model_fun=RW_Q, 
    acquisition_fun=ucb,
    data = d1,
    envs=environments
    ) # only try one sub
  #collect fitted parameters and fit index and return
  #social_data$modelfit=cv
  #output <- rbind(output, cv)
  #}
  cv
}
```

# dataframe

```{r}
plot_df<-data.table::rbindlist(social_sims_plot_d, idcol = "index")

plot_df%>%dplyr::group_by(trials,index)%>%filter(trials>0)%>%
  dplyr::summarise(m_rew=mean(out))%>%
  ggplot(aes(x=trials,y=m_rew))+
  #geom_line(aes(group=index))+
  stat_summary()


social_data%>%dplyr::group_by(trial,player)%>%filter(trial>0)%>%
  dplyr::summarise(m_rew=mean(points))%>%
  ggplot(aes(x=trial,y=m_rew))+
  #geom_line(aes(group=index))+
  stat_summary()

hist(social_fits$soc_w)
```

