---
title: "Regressions analyses main text"
author: "Andrea & Simon"
output: html_document
---

## load packages and prepare data
```{r echo=FALSE, warning=FALSE, message=FALSE, echo=FALSE}

## load packages @andrea implement pck_mgmt script
pacman::p_load(tidyverse,
               rjson,
               data.table,
               gghalves,
               here,
               lme4,
               lmerTest,
               broom.mixed,
               infer,
               ggthemes,
               sjPlot)

'%!in%' <- function(x,y)!('%in%'(x,y))

options(scipen = 999,digits = 4)
```

```{r load data, echo=FALSE, warning=FALSE, message=FALSE }

## load data
all_data <- read_csv(file = paste0(here(), "/data/social/data_social_all_participants.csv")) %>% 
   mutate(demo_quality_f = as.factor(demo_quality),
         age_f = factor(group, levels = c("adults", "adolescents"))) ## mutate IVs into factors
```

## differences in points scored by group

```{r points by age group regression}

## select only one observation per participant
performance_age_demonstrator <- all_data %>%
  ungroup() %>%
  select(uniqueID, age_f, demo_quality_f, tot_points) %>%
  distinct()

## load model if fitting has been done, if not fit model
if (file.exists(paste0(here(),'/G_Analysis_bevioral_data_social/modelfits/performance_age_demonstrator_model.RData'))){
  
  base::load(paste0(here(),'/G_Analysis_bevioral_data_social/modelfits/performance_age_demonstrator_model.RData'))

  } else {

## model specification
performance_age_demonstrator_model <-
  brms::brm(formula = tot_points ~ demo_quality_f * age_f + (1 |  uniqueID),
            data = performance_age_demonstrator,
            iter = 6000)

## save
save("performance_age_demonstrator_model", file = paste0(here(),'/G_Analysis_bevioral_data_social/modelfits/performance_age_demonstrator_model.RData'))
  }

## results
tab_model(performance_age_demonstrator_model)
plot_model(performance_age_demonstrator_model)


## bayes factor test main effects
brms::hypothesis(performance_age_demonstrator_model,"age_fadolescents > 0")
brms::hypothesis(performance_age_demonstrator_model,"demo_quality_fmedium < 0")
brms::hypothesis(performance_age_demonstrator_model,"demo_quality_fworst	 < 0") 

## bayes factor test interactions
brms::hypothesis(performance_age_demonstrator_model,"demo_quality_fmedium:age_fadolescents < 0")
brms::hypothesis(performance_age_demonstrator_model,"demo_quality_fworst:age_fadolescents <  0")


```

When do adults find gems? later then adolescents

```{r gem found when bry group, warning=FALSE, message=FALSE}

## select only one observation per participant
data_gem_found <- all_data %>%  
  filter(gem_found == 1) %>% 
    select(round_gem_found, age_f, demo_quality_f, uniqueID) %>% 
  distinct()

## gem found when by group 
data_gem_found %>% 
  ungroup() %>% 
  select(age_f, round_gem_found, demo_quality_f ) %>% 
  group_by(age_f) %>% 
  summarise( mean_copy = mean(round_gem_found),
             sd = sd (round_gem_found))


## mean copy by group and social information use 
data_gem_found %>% 
  ungroup() %>% 
  select(age_f, round_gem_found, demo_quality_f ) %>% 
  group_by(age_f, demo_quality_f) %>% 
  summarise( mean_copy = mean(round_gem_found),
             sd = sd (round_gem_found))

hist(data_gem_found$round_gem_found)


## load model if fitting has been done, if not fit model
if (file.exists(paste0(here(),'/G_Analysis_bevioral_data_social/modelfits/gem_found_when_model.RData'))){
  
  base::load(paste0(here(),'/G_Analysis_bevioral_data_social/modelfits/gem_found_when_model.RData'))
  
  } else {
  
## define priors 
prior_cauchy <- brms::prior_string("cauchy(0, 2.5)", class = "b")

## model specification
gem_found_when_model <- brms::brm(formula = round_gem_found ~  demo_quality_f * age_f + (1 | uniqueID),
          #prior = prior_cauchy,
        #  sample_prior = TRUE,
          data = data_gem_found,
          family = poisson(),
          iter = 6000,
          chains = 5) 

## save results
save(file = paste0(here(),'/G_Analysis_bevioral_data_social/modelfits/gem_found_when_model.RData'), gem_found_when_model)

  }

## bayes factor test main effects
brms::hypothesis(gem_found_when_model,"age_fadolescents <  0")
brms::hypothesis(gem_found_when_model,"demo_quality_fmedium < 0")
brms::hypothesis(gem_found_when_model,"demo_quality_fworst	 < 0") 

## bayes factor test interactions
brms::hypothesis(gem_found_when_model,"demo_quality_fmedium:age_fadolescents < 0")
brms::hypothesis(gem_found_when_model,"demo_quality_fworst:age_fadolescents <  0")

tab_model(gem_found_when_model)
plot_model(gem_found_when_model)

```

## social learning differences

```{r}
## create count variable
model_random_slopes_data <- all_data %>%
  group_by(uniqueID, round, gem_found, age_f, demo_quality_f) %>%
  filter(social_info_use == "copy") %>%
  count(social_info_use)

## mean copy by group %>% 
model_random_slopes_data %>% 
  ungroup() %>% 
  filter(n!=0) %>% 
  select(age_f, n,demo_quality_f ) %>% 
  group_by(age_f, demo_quality_f) %>% 
  summarise( mean_copy = mean(n),
             sd = sd (n))


## define priors
prior_cauchy <- brms::prior_string("cauchy(0, 2.5)", class = "b")

## specify model and fit
model_random_slopes <- brms::brm(formula = n ~ 1 + demo_quality_f * age_f + (1 + demo_quality_f | uniqueID),
          prior = prior_cauchy,
          sample_prior = TRUE,
          data = model_random_slopes_data,
          family = poisson(),
          iter = 6000,
          chains = 5) 

## save results
save(file = paste0(here(),'/G_Analysis_bevioral_data_social/modelfits/poission_regression_all_rounds_slopes.RData'), model_random_slopes)

load(file = paste0(here(),'/G_Analysis_bevioral_data_social/modelfits/poission_regression_all_rounds_slopes.RData'))

## bayes factor test main effects
brms::hypothesis(model_random_slopes,"age_fadolescents > 0")
brms::hypothesis(model_random_slopes,"demo_quality_fmedium < 0")
brms::hypothesis(model_random_slopes,"demo_quality_fworst	 < 0") 

## bayes factor test interactions
brms::hypothesis(model_random_slopes,"demo_quality_fmedium:age_fadolescents < 0")
brms::hypothesis(model_random_slopes,"demo_quality_fworst:age_fadolescents = 0")

plot_model(model_random_slopes)
```


```{r}

all_data %>% 
  ungroup %>% 
  group_by(unique_rounds) %>% 
  mutate(running_total = cumsum(points)) %>% 
  ggplot() +
  stat_summary(aes(x = trial, y = running_total, color= as.factor(group))) +
  facet_wrap(~demo_quality)
  
all_data %>% 
  ungroup %>% 
  group_by(unique_rounds) %>% 
  mutate(running_total = cumsum(points)) %>% 
  ggplot() +
  stat_summary(aes(x = trial, y = points, color= as.factor(group))) +
  facet_wrap(~demo_quality)

summary(lmer(points ~ trial + group * demo_type +(1|uniqueID), data = all_data))

summary(lmer(points ~ trial + group * demo_quality +(1|uniqueID), data = all_data))

## finish this
brms::brm(points ~ trial + age_f * demo_quality_f +(1|uniqueID), data = all_data, chains = 4, iter = 4000)


```

